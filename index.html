<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Short Report Trainer (5W+H)</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background:#0b1220; color:#e9eefc; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 18px; }
    .card { background:#111b33; border:1px solid rgba(255,255,255,.08); border-radius: 14px; padding: 16px; }
    .topbar { display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom: 12px; flex-wrap:wrap; }
    .badge { padding:6px 10px; border-radius:999px; background:#1a2a55; border:1px solid rgba(255,255,255,.10); font-weight:700; }
    .progress { flex: 1; min-width: 240px; height: 10px; background: rgba(255,255,255,.10); border-radius: 999px; overflow:hidden; }
    .progress > div { height: 100%; width: 0%; background: #7aa2ff; }
    .scenarioHeader {
      margin: 8px 0 12px;
      padding: 12px;
      border-radius: 12px;
      background: rgba(122,162,255,.10);
      border: 1px solid rgba(122,162,255,.25);
    }
    .scenarioHeader .big { font-size: 18px; font-weight: 900; letter-spacing: .2px; }
    .scenarioHeader .line { margin-top: 6px; font-size: 16px; font-weight: 800; }
    .scenarioHeader .meta { margin-top: 6px; opacity:.9; font-size: 13px; }
    .grid { display:grid; grid-template-columns: 1.1fr .9fr; gap: 14px; }
    @media (max-width: 860px){ .grid { grid-template-columns: 1fr; } }
    img { width:100%; height:auto; border-radius: 12px; border:1px solid rgba(255,255,255,.10); background:#0b1220; }
    label { display:block; font-weight: 700; margin: 10px 0 6px; }
    input, textarea {
      width:100%; box-sizing:border-box;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,.14);
      background:#0b1220;
      color:#e9eefc;
      padding: 10px 12px;
      outline:none;
    }
    textarea { min-height: 84px; resize: vertical; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 540px){ .row { grid-template-columns: 1fr; } }
    .hint { margin-top:8px; padding:10px 12px; border-radius:10px; background: rgba(255,205,117,.10); border:1px solid rgba(255,205,117,.25); color:#ffe2b0; display:none; }
    .error { margin-top:10px; padding:10px 12px; border-radius:10px; background: rgba(255,90,90,.12); border:1px solid rgba(255,90,90,.25); color:#ffd0d0; display:none; }
    .ok { margin-top:10px; padding:10px 12px; border-radius:10px; background: rgba(100,255,160,.12); border:1px solid rgba(100,255,160,.25); color:#c9ffe2; display:none; }
    button {
      margin-top: 12px;
      border:0; border-radius: 12px;
      padding: 10px 14px;
      font-weight: 900;
      cursor:pointer;
      background:#7aa2ff; color:#071022;
    }
    button:disabled { opacity:.55; cursor:not-allowed; }
    .small { opacity:.85; font-size: 12px; margin-top: 6px; }
    .footerNote { opacity:.75; font-size: 12px; margin-top: 10px; }
  </style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div class="badge" id="scenarioBadge">SCENARIO —</div>
    <div class="progress" aria-label="progress"><div id="progressBar"></div></div>
    <div class="badge" id="progressText">0 / 0</div>
  </div>

  <div class="card">
    <div class="scenarioHeader" aria-live="polite">
      <div class="big" id="scenarioTitle">Scenario</div>
      <div class="line" id="givenLine1">GIVEN LOCATION: —</div>
      <div class="line" id="givenLine2">GIVEN DATE/TIME: —</div>
      <div class="meta" id="givenLine3">Time zone letter required: —</div>
    </div>

    <div class="grid">
      <div>
        <img id="scenarioImg" src="" alt="Scenario image" />
      </div>

      <div>
        <form id="reportForm">
          <label for="studentName">Student name(s)</label>
          <input id="studentName" name="studentName" required placeholder="e.g., Alex & Sam" />

          <label for="who">WHO</label>
          <input id="who" name="who" required placeholder="Who is involved?" />

          <label for="what">WHAT</label>
          <input id="what" name="what" required placeholder="What is happening?" />

          <div class="row">
            <div>
              <label for="where">WHERE (MGRS)</label>
              <input id="where" name="where" required placeholder="e.g., 31U FT 8302 6856" />
              <div class="small">Must be within 10 meters. Hint appears after 2 failed attempts.</div>
              <div class="hint" id="mgrsHint"></div>
            </div>
            <div>
              <label for="when">WHEN (DTG)</label>
              <input id="when" name="when" required placeholder="e.g., 251435A JAN 2026" />
              <div class="small">Format: DDHHMM(A|B) MON YYYY (A=winter, B=summer)</div>
            </div>
          </div>

          <label for="how">HOW</label>
          <input id="how" name="how" required placeholder="How did it happen / how is it developing?" />

          <label for="note">NOTE / additional information (optional)</label>
          <textarea id="note" name="note" placeholder="Optional details (not required)"></textarea>

          <!-- Hidden / internal -->
          <input type="hidden" id="scenarioId" name="scenarioId" />
          <button id="submitBtn" type="submit">Submit & Next</button>

          <div class="error" id="errorBox"></div>
          <div class="ok" id="okBox"></div>
          <div class="footerNote">Submits to Google Forms and then loads the next random scenario automatically.</div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
/**
 * GOOGLE FORMS CONFIG
 * 1) Replace FORM_ACTION with your formResponse endpoint
 * 2) Keep ENTRY mapping as you provided
 */
const FORM_ACTION = "1CoS9pgsz95tvlZY0kI_hySjIMYwA-kHkQ8Eg5023P6s";

const ENTRY = {
  studentName: "entry.697813513",
  who:         "entry.950739082",
  what:        "entry.724583571",
  where:       "entry.1339994849",
  when:        "entry.2133718989",
  how:         "entry.464832105",
  note:        "entry.2091019514",
  scenarioId:  "entry.1482083770"
};

/**
 * SCENARIOS
 * - date: YYYY-MM-DD
 * - time: HH:MM (24h)
 * - tz: "A" (winter) or "B" (summer)
 * - mgrs8: 8-digit precision (10m): "31U FT 8302 6856"
 */
const SCENARIOS = [
  { id:"S1", img:"images/img1.jpg", location:"Topsporthal Van de Knaap – Main entrance (Ede)", date:"2026-01-25", time:"14:35", tz:"A", mgrs8:"31U FT 8302 6856" },
  { id:"S2", img:"images/img2.jpg", location:"Pathé Ede – Parking lot",                      date:"2026-06-12", time:"09:10", tz:"B", mgrs8:"31U FT 8170 6609" },
  { id:"S3", img:"images/img3.jpg", location:"Winkelcentrum Stadspoort – Near AH entrance",  date:"2026-03-03", time:"18:22", tz:"A", mgrs8:"31U FT 8179 6631" },
  { id:"S4", img:"images/img4.jpg", location:"Kasteel Hoekelum – Near the lake",            date:"2026-05-09", time:"12:05", tz:"B", mgrs8:"31U FT 8366 6614" },
  { id:"S5", img:"images/img5.jpg", location:"Ziekenhuis Gelderse Vallei – Main entrance",  date:"2026-02-14", time:"07:50", tz:"A", mgrs8:"31U FT 8149 6688" },
  { id:"S6", img:"images/img6.jpg", location:"Zwembad De Peppel – Front entrance",          date:"2026-07-21", time:"16:40", tz:"B", mgrs8:"31U FT 8106 6834" },
  { id:"S7", img:"images/img7.jpg", location:"Oude Kerk Ede – Grotestraat side",            date:"2026-11-08", time:"10:15", tz:"A", mgrs8:"31U FT 8319 6952" },
  { id:"S8", img:"images/img8.jpg", location:"Station Ede-Wageningen – Main plaza",         date:"2026-08-30", time:"20:05", tz:"B", mgrs8:"31U FT 8330 6749" },
];

/* ----------------------- Random order per session ----------------------- */
function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

function loadOrder() {
  const key = "scenarioOrder_v1";
  const raw = sessionStorage.getItem(key);
  if (raw) {
    try {
      const ids = JSON.parse(raw);
      const map = new Map(SCENARIOS.map(s => [s.id, s]));
      const ordered = ids.map(id => map.get(id)).filter(Boolean);
      // if missing, fall back
      if (ordered.length === SCENARIOS.length) return ordered;
    } catch(e){}
  }
  const ordered = shuffle([...SCENARIOS]);
  sessionStorage.setItem(key, JSON.stringify(ordered.map(s => s.id)));
  return ordered;
}

const ORDER = loadOrder();

/* ------------------------------ UI refs ------------------------------ */
const scenarioBadge = document.getElementById("scenarioBadge");
const progressText  = document.getElementById("progressText");
const progressBar   = document.getElementById("progressBar");

const scenarioTitle = document.getElementById("scenarioTitle");
const givenLine1    = document.getElementById("givenLine1");
const givenLine2    = document.getElementById("givenLine2");
const givenLine3    = document.getElementById("givenLine3");

const scenarioImg   = document.getElementById("scenarioImg");

const form          = document.getElementById("reportForm");
const submitBtn     = document.getElementById("submitBtn");

const errorBox      = document.getElementById("errorBox");
const okBox         = document.getElementById("okBox");
const mgrsHint      = document.getElementById("mgrsHint");

/* ----------------------- State ----------------------- */
let idx = 0;

// keep per-scenario failed attempts for MGRS
const mgrsFails = {}; // { [scenarioId]: number }

/* ----------------------- Helpers: DTG validation ----------------------- */
const MONTHS = ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];

function pad2(n){ return String(n).padStart(2,"0"); }

function dtgExpected(scn){
  // Expected: DDHHMM + tz + MON + YYYY
  const [y,m,d] = scn.date.split("-").map(Number);
  const [hh,mm] = scn.time.split(":").map(Number);
  const mon = MONTHS[m-1];
  return `${pad2(d)}${pad2(hh)}${pad2(mm)}${scn.tz} ${mon} ${y}`;
}

function parseDTG(input){
  // Accept flexible spaces: "DDHHMMA MON YYYY"
  // e.g. 251435A JAN 2026
  const s = input.trim().toUpperCase().replace(/\s+/g," ");
  const m = s.match(/^(\d{2})(\d{2})(\d{2})([AB])\s+([A-Z]{3})\s+(\d{4})$/);
  if(!m) return null;
  return {
    day: Number(m[1]),
    hour: Number(m[2]),
    min: Number(m[3]),
    tz: m[4],
    mon: m[5],
    year: Number(m[6]),
  };
}

function validateDTG(input, scn){
  const p = parseDTG(input);
  if(!p) return { ok:false, msg:"WHEN must be a DTG like: DDHHMM(A|B) MON YYYY (e.g., 251435A JAN 2026)." };

  const [y,m,d] = scn.date.split("-").map(Number);
  const [hh,mm] = scn.time.split(":").map(Number);
  const expMon = MONTHS[m-1];

  if (p.year !== y) return { ok:false, msg:"WHEN: year does not match the scenario date." };
  if (p.mon !== expMon) return { ok:false, msg:"WHEN: month does not match the scenario date." };
  if (p.day !== d) return { ok:false, msg:"WHEN: day does not match the scenario date." };
  if (p.hour !== hh || p.min !== mm) return { ok:false, msg:"WHEN: time does not match the scenario time." };
  if (p.tz !== scn.tz) return { ok:false, msg:"WHEN: time zone letter must match (A=winter, B=summer)." };

  return { ok:true };
}

/* ----------------------- Helpers: MGRS parsing & 10m check -----------------------
   We only need:
   - accept "31U FT 8302 6856" (8-digit)
   - accept variants without spaces: "31UFT83026856" etc
   - compute distance in meters between two MGRS (same zone/band) using UTM math
*/
const E100K = ["ABCDEFGH", "JKLMNPQR", "STUVWXYZ"];
const N100K = ["ABCDEFGHJKLMNPQRSTUV", "FGHJKLMNPQRSTUVABCDE"];
const LAT_BANDS = "CDEFGHJKLMNPQRSTUVWX";

function cleanMgrs(str){
  return str.toUpperCase().trim().replace(/\s+/g,"");
}

function parseMgrs(mgrs){
  // Supports: 31UFT83026856 OR 31UFT83026856 (must be 4+4 digits here)
  const s = cleanMgrs(mgrs);
  // zone(1-2) + band(1) + 2 letters + 8 digits
  const m = s.match(/^(\d{1,2})([C-HJ-NP-X])([A-HJ-NP-Z]{2})(\d{4})(\d{4})$/);
  if(!m) return null;
  return {
    zone: Number(m[1]),
    band: m[2],
    sq: m[3],
    e: Number(m[4]) * 10, // 4 digits => 10m
    n: Number(m[5]) * 10
  };
}

function bandSouthLat(band){
  const i = LAT_BANDS.indexOf(band);
  if (i < 0) return null;
  if (band === "X") return 72;
  return -80 + i * 8;
}

function utmNorthingAtLat(zone, lat){
  // Approx band south edge northing on central meridian of zone
  const lon0 = (zone - 1) * 6 - 180 + 3; // zone central meridian
  return llToUtm(zone, lat, lon0).n;
}

function llToUtm(zone, lat, lon){
  // WGS84 UTM forward
  // simplified implementation: use formulas? -> we use the same math as typical, but here we do a lightweight conversion.
  // For our purposes (Ede area), this is accurate enough for 10m checks given consistent parsing.
  // Using standard transverse mercator constants.
  const a = 6378137.0;
  const f = 1/298.257223563;
  const k0 = 0.9996;
  const e2 = f*(2-f);
  const ep2 = e2/(1-e2);

  const latRad = lat * Math.PI/180;
  const lonRad = lon * Math.PI/180;
  const lon0 = ((zone - 1) * 6 - 180 + 3) * Math.PI/180;

  const N = a / Math.sqrt(1 - e2 * Math.sin(latRad)**2);
  const T = Math.tan(latRad)**2;
  const C = ep2 * Math.cos(latRad)**2;
  const A = Math.cos(latRad) * (lonRad - lon0);

  const M = a*((1 - e2/4 - 3*e2**2/64 - 5*e2**3/256)*latRad
    - (3*e2/8 + 3*e2**2/32 + 45*e2**3/1024)*Math.sin(2*latRad)
    + (15*e2**2/256 + 45*e2**3/1024)*Math.sin(4*latRad)
    - (35*e2**3/3072)*Math.sin(6*latRad));

  let easting = k0*N*(A + (1-T+C)*A**3/6 + (5 - 18*T + T**2 + 72*C - 58*ep2)*A**5/120) + 500000;
  let northing = k0*(M + N*Math.tan(latRad)*(A**2/2 + (5 - T + 9*C + 4*C**2)*A**4/24
                 + (61 - 58*T + T**2 + 600*C - 330*ep2)*A**6/720));
  if (lat < 0) northing += 10000000;
  return { e: easting, n: northing };
}

function mgrsToUtm(mgrs){
  const p = parseMgrs(mgrs);
  if(!p) return null;

  const zone = p.zone;
  const band = p.band;
  const setCol = (zone - 1) % 3;
  const setRow = (zone - 1) % 2;

  const colLetter = p.sq[0];
  const rowLetter = p.sq[1];

  const colIndex = E100K[setCol].indexOf(colLetter);
  const rowIndex = N100K[setRow].indexOf(rowLetter);
  if(colIndex < 0 || rowIndex < 0) return null;

  // 100k block base
  const e100k = (colIndex + 1) * 100000;
  let n100k = rowIndex * 100000;

  // Add 2,000,000m cycles until within correct latitude band
  const southLat = bandSouthLat(band);
  if(southLat == null) return null;

  const minN = utmNorthingAtLat(zone, southLat);
  while (n100k + p.n < minN) n100k += 2000000;

  return { zone, band, e: e100k + p.e, n: n100k + p.n };
}

function distanceMeters(utm1, utm2){
  if(!utm1 || !utm2) return Infinity;
  if(utm1.zone !== utm2.zone) return Infinity;
  const dx = utm1.e - utm2.e;
  const dy = utm1.n - utm2.n;
  return Math.sqrt(dx*dx + dy*dy);
}

function validateMGRS(input, scn){
  const user = mgrsToUtm(input);
  if(!user) return { ok:false, msg:"WHERE must be an MGRS coordinate with 8 digits, e.g., 31U FT 8302 6856." };

  const exp = mgrsToUtm(scn.mgrs8);
  if(!exp) return { ok:false, msg:"Internal scenario MGRS is invalid (teacher config)." };

  // enforce same zone+band+100k? (optional) – distance check already prevents weird far-away entries
  const dist = distanceMeters(user, exp);
  if(dist > 10.0) return { ok:false, msg:`WHERE is not within 10 meters of the correct coordinate (distance ~${Math.round(dist)}m).` };

  return { ok:true };
}

/* ----------------------- Scenario rendering ----------------------- */
function setProgress(){
  progressText.textContent = `${idx+1} / ${ORDER.length}`;
  progressBar.style.width = `${((idx+1)/ORDER.length)*100}%`;
}

function renderScenario(){
  const scn = ORDER[idx];

  scenarioBadge.textContent = `SCENARIO ${scn.id}`;
  scenarioTitle.textContent = `Scenario ${scn.id}`;
  givenLine1.textContent = `GIVEN LOCATION: ${scn.location}`;
  givenLine2.textContent = `GIVEN DATE/TIME: ${scn.date}  ${scn.time}`;
  givenLine3.textContent = `Time zone letter required: ${scn.tz}  (A = winter time, B = summer time)`;

  document.getElementById("scenarioId").value = scn.id;
  scenarioImg.src = scn.img;

  // reset inputs (EXCEPT studentName – keep it)
  ["who","what","where","when","how","note"].forEach(id => {
    document.getElementById(id).value = "";
  });

  // hide messages
  errorBox.style.display = "none";
  okBox.style.display = "none";

  // hint visibility depends on failed attempts
  const fails = mgrsFails[scn.id] || 0;
  if (fails >= 2){
    mgrsHint.textContent = `Hint (MGRS 8-digit): ${scn.mgrs8}`;
    mgrsHint.style.display = "block";
  } else {
    mgrsHint.style.display = "none";
  }

  setProgress();
}

renderScenario();

/* ----------------------- Submit to Google Forms ----------------------- */
function showError(msg){
  errorBox.textContent = msg;
  errorBox.style.display = "block";
  okBox.style.display = "none";
}

function showOk(msg){
  okBox.textContent = msg;
  okBox.style.display = "block";
  errorBox.style.display = "none";
}

async function postToGoogleForms(payload){
  // payload is URLSearchParams
  // Important: Google Forms often blocks CORS. If it fails in-browser, use "no-cors".
  try {
    await fetch(FORM_ACTION, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: payload.toString()
    });
    return true;
  } catch(e){
    return false;
  }
}

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const scn = ORDER[idx];

  const studentName = document.getElementById("studentName").value.trim();
  const who   = document.getElementById("who").value.trim();
  const what  = document.getElementById("what").value.trim();
  const where = document.getElementById("where").value.trim();
  const when  = document.getElementById("when").value.trim();
  const how   = document.getElementById("how").value.trim();
  const note  = document.getElementById("note").value.trim(); // optional
  const scenarioId = scn.id;

  // Basic required checks
  if(!studentName || !who || !what || !where || !when || !how){
    showError("Please fill in all required fields (NOTE is optional).");
    return;
  }

  // Validate WHEN (DTG) – must match scenario date/time and A/B letter
  const dtgCheck = validateDTG(when, scn);
  if(!dtgCheck.ok){
    showError(dtgCheck.msg);
    return;
  }

  // Validate WHERE (MGRS) within 10m; hint after 2 failures
  const mgrsCheck = validateMGRS(where, scn);
  if(!mgrsCheck.ok){
    mgrsFails[scn.id] = (mgrsFails[scn.id] || 0) + 1;

    // show hint only after 2 failed attempts
    if(mgrsFails[scn.id] >= 2){
      mgrsHint.textContent = `Hint (MGRS 8-digit): ${scn.mgrs8}`;
      mgrsHint.style.display = "block";
    }

    showError(mgrsCheck.msg);
    return;
  }

  // Build Google Forms payload
  const data = new URLSearchParams();
  data.append(ENTRY.studentName, studentName);
  data.append(ENTRY.who, who);
  data.append(ENTRY.what, what);
  data.append(ENTRY.where, where);
  data.append(ENTRY.when, when);
  data.append(ENTRY.how, how);
  data.append(ENTRY.note, note);         // optional field (empty allowed)
  data.append(ENTRY.scenarioId, scenarioId);

  submitBtn.disabled = true;
  showOk("Submitted! Loading next scenario...");

  await postToGoogleForms(data);

  // Next scenario
  idx++;
  if(idx >= ORDER.length){
    // finished
    submitBtn.disabled = true;
    scenarioTitle.textContent = "Done!";
    givenLine1.textContent = "All scenarios completed.";
    givenLine2.textContent = "You can close this tab.";
    givenLine3.textContent = "";
    scenarioImg.style.display = "none";
    form.style.display = "none";
    return;
  }

  submitBtn.disabled = false;
  renderScenario();
});
</script>
</body>
</html>
