<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Short Report Trainer</title>

  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background:#0b1220; color:#e9eefc; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 18px; }

    .card {
      background:#111b33;
      border:1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      padding: 16px;
    }

    .topbar {
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      margin-bottom: 12px; flex-wrap:wrap;
    }
    .badge {
      padding:6px 12px; border-radius:999px;
      background:#1a2a55;
      border:1px solid rgba(255,255,255,.10);
      font-weight:900;
    }
    .progress {
      flex: 1; min-width: 240px; height: 10px;
      background: rgba(255,255,255,.12);
      border-radius: 999px; overflow:hidden;
    }
    .progress > div { height: 100%; width: 0%; background: #7aa2ff; }

    .scenarioHeader {
      margin: 8px 0 12px;
      padding: 12px;
      border-radius: 12px;
      background: rgba(122,162,255,.10);
      border: 1px solid rgba(122,162,255,.25);
    }
    .scenarioHeader .big { font-size: 20px; font-weight: 950; text-align:center; }
    .scenarioHeader .line { margin-top: 8px; font-size: 17px; text-align:center; }
    .label { font-weight: 500; opacity: .95; }    /* niet vet */
    .value { font-weight: 900; }                  /* wel vet */

    .grid { display:grid; grid-template-columns: 1.1fr .9fr; gap: 14px; }
    @media (max-width: 860px){ .grid { grid-template-columns: 1fr; } }

    img {
      width:100%;
      height:auto;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      background:#0b1220;
    }

    label { display:block; font-weight: 800; margin: 10px 0 6px; }

    input, textarea {
      width:100%; box-sizing:border-box;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,.14);
      background:#0b1220;
      color:#e9eefc;
      padding: 10px 12px;
      outline:none;
    }
    textarea { min-height: 84px; resize: vertical; }

    .row { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 540px){ .row { grid-template-columns: 1fr; } }

    .mgrsRow { display:flex; gap:8px; align-items:center; }
    .mgrsFixed {
      width: 92px;
      text-align:center;
      opacity:.95;
      background: rgba(255,255,255,.06);
    }
    #mgrsDigits{
      text-align:center;
      font-variant-numeric: tabular-nums;
      letter-spacing: .9px;
    }

    .hint, .error, .ok {
      margin-top:10px;
      padding:10px 12px;
      border-radius:10px;
      display:none;
      border:1px solid rgba(255,255,255,.12);
    }
    .hint { background: rgba(255,205,117,.12); border-color: rgba(255,205,117,.25); color:#ffe2b0; }
    .error { background: rgba(255,90,90,.18); border-color: rgba(255,90,90,.25); color:#ffd0d0; }
    .ok { background: rgba(100,255,160,.14); border-color: rgba(100,255,160,.25); color:#c9ffe2; }

    button {
      margin-top: 14px;
      border:0; border-radius: 12px;
      padding: 10px 14px;
      font-weight: 950;
      cursor:pointer;
      background:#7aa2ff; color:#071022;
    }
    button:disabled { opacity:.55; cursor:not-allowed; }

    .footerNote { opacity:.80; font-size: 12px; margin-top: 10px; line-height:1.35; }
    code { background: rgba(255,255,255,.10); padding: 2px 6px; border-radius: 8px; }
  </style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div class="badge" id="scenarioBadge">Scenario 1 van 8</div>
    <div class="progress" aria-label="voortgang"><div id="progressBar"></div></div>
    <div class="badge" id="progressText">1 / 8</div>
  </div>

  <div class="card">
    <div class="scenarioHeader" aria-live="polite">
      <div class="big" id="scenarioTitle">Scenario</div>
      <div class="line">
        <span class="label">Gegeven locatie:</span>
        <span class="value" id="givenLocation">—</span>
      </div>
      <div class="line">
        <span class="label">Gegeven datum/tijd:</span>
        <span class="value" id="givenDateTime">—</span>
      </div>
    </div>

    <div class="grid">
      <div>
        <img id="scenarioImg" src="" alt="Scenario afbeelding" />
      </div>

      <div>
        <div class="footerNote">
          <b>WHEN (DTG)</b> formaat: <code>DDHHMM(A|B) MON JJ</code> — voorbeeld: <code>251435A JAN 26</code><br>
          <b>WHERE (MGRS – WGS84)</b>: prefix staat vast, jij vult alleen de 8 cijfers in (4+4). Je mag <code>83016636</code> of <code>8301 6636</code> typen.
        </div>

        <form id="reportForm" novalidate>
          <label for="studentName">Naam student(en)</label>
          <input id="studentName" required placeholder="Bijv. Alex & Sam" />

          <label for="who">WHO (Callsign)</label>
          <input id="who" required placeholder="Bijv. Alpha 1 / Patrol 2 / Observer" />

          <label for="what">WHAT</label>
          <input id="what" required placeholder="Hoofdgroep, tekst, grootte, kleur" />

          <div class="row">
            <div>
              <label>WHERE (MGRS – WGS84)</label>
              <div class="mgrsRow">
                <input class="mgrsFixed" value="31U FT" disabled aria-label="MGRS prefix" />
                <input id="mgrsDigits" required placeholder="bijv. 8301 6636" aria-label="MGRS 8 cijfers (4+4)" />
              </div>
              <div class="hint" id="mgrsHint"></div>
            </div>

            <div>
              <label for="when">WHEN (DTG)</label>
              <input id="when" required placeholder="Bijv. 251435A JAN 26" />
              <div class="hint" id="dtgHint"></div>
            </div>
          </div>

          <label for="how">HOW</label>
          <input id="how" required placeholder="Naderingsroute, contactpersoon, markering" />

          <label for="note">NOTE (optioneel)</label>
          <textarea id="note" placeholder="Optioneel"></textarea>

          <button id="submitBtn" type="submit">Versturen & volgende</button>

          <div class="error" id="errorBox"></div>
          <div class="ok" id="okBox"></div>

          <div class="footerNote">
            Regel: 1e fout blokkeert. Na 2 foute pogingen zie je het juiste antwoord en mag je inleveren met jouw laatst ingevulde (foute) antwoord.
            Als je wordt doorgelaten met een fout, blijft het juiste antwoord <b>10 seconden</b> in beeld.
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
/* =======================
   Google Forms endpoint
   ======================= */
const FORM_ACTION = "https://docs.google.com/forms/d/e/1FAIpQLSe3-GOHTC225b7tcRCHNH5xK9X0lNplRsGfmlQcL_1pMVhcqA/formResponse";

const ENTRY = {
  studentName: "entry.697813513",
  who:         "entry.950739082",
  what:        "entry.724583571",
  where:       "entry.1339994849",
  when:        "entry.2133718989",
  how:         "entry.464832105",
  note:        "entry.2091019514",
  scenarioId:  "entry.1482083770"
};

/* =======================
   Scenario data (8)
   - d: YYYY-MM-DD
   - t: HH:MM (24h)
   - tz: A/B (Alpha winter / Bravo zomer)
   - mgrsDigits: "#### ####" (8 digits / 10m)
   ======================= */
const SCENARIOS = [
  { id:"S1", img:"images/img1.jpg", loc:"Topsporthal Van der Knaap – hoofdingang",          d:"2026-01-25", t:"14:35", tz:"A", mgrsDigits:"8301 6636" },
  { id:"S2", img:"images/img2.jpg", loc:"Pathé Ede – parkeerplaats",                        d:"2026-06-12", t:"09:10", tz:"B", mgrsDigits:"8174 6614" },
  { id:"S3", img:"images/img3.jpg", loc:"Stadspoort – parkeerplaats",                        d:"2026-03-03", t:"18:22", tz:"A", mgrsDigits:"8197 6629" },
  { id:"S4", img:"images/img4.jpg", loc:"Kasteel Hoekelum – zuidkant meer",                  d:"2026-05-09", t:"12:05", tz:"B", mgrsDigits:"8372 6611" },
  { id:"S5", img:"images/img5.jpg", loc:"Ziekenhuis Gelderse Vallei – hoofdingang",          d:"2026-02-14", t:"07:50", tz:"A", mgrsDigits:"8156 6680" },
  { id:"S6", img:"images/img6.jpg", loc:"Zwembad De Peppel – ingang",                        d:"2026-07-21", t:"16:40", tz:"B", mgrsDigits:"8132 6842" },
  { id:"S7", img:"images/img7.jpg", loc:"Oude Kerk – Grotestraat",                           d:"2026-11-08", t:"10:15", tz:"A", mgrsDigits:"8317 6953" },
  { id:"S8", img:"images/img8.jpg", loc:"Station Ede-Wageningen – nieuwe locatie",           d:"2026-08-30", t:"20:05", tz:"B", mgrsDigits:"8353 6744" }
];

const MONTHS_NL = ["januari","februari","maart","april","mei","juni","juli","augustus","september","oktober","november","december"];
const MONTHS_EN = ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];

function el(id){ return document.getElementById(id); }
function show(node, yes){ node.style.display = yes ? "block" : "none"; }

function normSpaces(s){ return (s || "").toUpperCase().trim().replace(/\s+/g," "); }

/* Extract exactly the last 8 digits typed (accepts "83016636", "8301 6636", or "31UFT83016636") */
function extractMgrs8Digits(raw){
  const digits = String(raw || "").replace(/\D/g, "");
  if(digits.length < 8) return null;
  return digits.slice(-8);
}
function formatMgrs8(d8){
  return `${d8.slice(0,4)} ${d8.slice(4,8)}`;
}

function formatDateNL(iso){
  const [y,m,d] = iso.split("-").map(Number);
  return `${String(d).padStart(2,"0")} ${MONTHS_NL[m-1]} ${y}`;
}

function expectedDTG(s){
  const dd = s.d.slice(8,10);
  const hhmm = s.t.replace(":","");
  const mon = MONTHS_EN[Number(s.d.slice(5,7)) - 1];
  const jj = s.d.slice(2,4);
  return `${dd}${hhmm}${s.tz} ${mon} ${jj}`;
}

/* =======================
   Random order per sessie
   ======================= */
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

function loadOrder(){
  const key = "short_report_order_v4";
  const raw = sessionStorage.getItem(key);
  if(raw){
    try{
      const ids = JSON.parse(raw);
      const map = new Map(SCENARIOS.map(s => [s.id, s]));
      const ordered = ids.map(id => map.get(id)).filter(Boolean);
      if(ordered.length === SCENARIOS.length) return ordered;
    }catch(e){}
  }
  const ordered = shuffle(SCENARIOS);
  sessionStorage.setItem(key, JSON.stringify(ordered.map(s => s.id)));
  return ordered;
}

const ORDER = loadOrder();

/* Attempts per scenario */
let idx = 0;
const failWhere = {};
const failWhen  = {};

/* UI */
function setProgress(){
  el("scenarioBadge").textContent = `Scenario ${idx+1} van ${ORDER.length}`;
  el("progressText").textContent  = `${idx+1} / ${ORDER.length}`;
  el("progressBar").style.width   = `${((idx+1)/ORDER.length)*100}%`;
}

function renderScenario(){
  const s = ORDER[idx];

  el("scenarioTitle").textContent = `Scenario ${s.id}`;
  el("givenLocation").textContent = s.loc;
  el("givenDateTime").textContent = `${formatDateNL(s.d)} ${s.t}`;
  el("scenarioImg").src = s.img;

  // reset velden behalve studentName
  ["who","what","how","note","when"].forEach(id => el(id).value = "");
  el("mgrsDigits").value = "";

  show(el("errorBox"), false);
  show(el("okBox"), false);
  show(el("mgrsHint"), false);
  show(el("dtgHint"), false);

  setProgress();
}
renderScenario();

function error(msg){
  el("errorBox").textContent = msg;
  show(el("errorBox"), true);
  show(el("okBox"), false);
}
function ok(msg){
  el("okBox").textContent = msg;
  show(el("okBox"), true);
  show(el("errorBox"), false);
}

/* Input: if we can extract 8 digits, format into "#### ####" (allows typing without spaces) */
el("mgrsDigits").addEventListener("input", () => {
  const d8 = extractMgrs8Digits(el("mgrsDigits").value);
  if(d8) el("mgrsDigits").value = formatMgrs8(d8);
});

/* Submit */
el("reportForm").addEventListener("submit", (e) => {
  e.preventDefault();

  const s = ORDER[idx];

  const studentName = el("studentName").value.trim();
  const who  = el("who").value.trim();
  const what = el("what").value.trim();
  const how  = el("how").value.trim();
  const note = el("note").value.trim();

  const user8 = extractMgrs8Digits(el("mgrsDigits").value);
  const whenInput = normSpaces(el("when").value);

  // required
  if(!studentName || !who || !what || !how){
    error("Vul alle verplichte velden in (NOTE is optioneel).");
    return;
  }
  if(!user8){
    error("WHERE is verplicht: vul 8 cijfers in (4 + 4), bijv. 8301 6636.");
    return;
  }
  if(!whenInput){
    error("WHEN is verplicht: vul een datumtijdgroep (DTG) in.");
    return;
  }

  // expected
  const expected8 = s.mgrsDigits.replace(/\s+/g,""); // "83016636"
  const expectedWhen = expectedDTG(s);

  // 10m tolerant: difference of at most 1 grid step (10m) overall distance
  const ue = parseInt(user8.slice(0,4), 10);
  const un = parseInt(user8.slice(4,8), 10);
  const ee = parseInt(expected8.slice(0,4), 10);
  const en = parseInt(expected8.slice(4,8), 10);

  const dx = (ue - ee) * 10;
  const dy = (un - en) * 10;
  const dist = Math.hypot(dx, dy);
  const whereCorrect = (dist <= 10);

  const whenCorrect = (whenInput === expectedWhen);

  let needsTenSeconds = false;

  // WHERE incorrect -> block first time; show answer second time but allow
  if(!whereCorrect){
    failWhere[s.id] = (failWhere[s.id] || 0) + 1;

    if(failWhere[s.id] < 2){
      show(el("mgrsHint"), false);
      error("WHERE is onjuist. Probeer opnieuw.");
      return;
    }

    el("mgrsHint").textContent = `Juiste WHERE (MGRS): 31U FT ${s.mgrsDigits}`;
    show(el("mgrsHint"), true);
    needsTenSeconds = true;
  }

  // WHEN incorrect -> block first time; show answer second time but allow
  if(!whenCorrect){
    failWhen[s.id] = (failWhen[s.id] || 0) + 1;

    if(failWhen[s.id] < 2){
      show(el("dtgHint"), false);
      error("WHEN (DTG) is onjuist. Probeer opnieuw.");
      return;
    }

    el("dtgHint").innerHTML = `Juiste WHEN (DTG): <code>${expectedWhen}</code>`;
    show(el("dtgHint"), true);
    needsTenSeconds = true;
  }

  // WHERE for Forms (always full + formatted)
  const whereFull = `31U FT ${formatMgrs8(user8)}`;

  // Submit exact student answers (even if wrong after 2 attempts)
  const data = new URLSearchParams();
  data.append(ENTRY.studentName, studentName);
  data.append(ENTRY.who, who);
  data.append(ENTRY.what, what);
  data.append(ENTRY.where, whereFull);
  data.append(ENTRY.when, whenInput);
  data.append(ENTRY.how, how);
  if(note) data.append(ENTRY.note, note);
  data.append(ENTRY.scenarioId, s.id);

  el("submitBtn").disabled = true;

  if(needsTenSeconds){
    ok("Je mag door. Het juiste antwoord blijft 10 seconden in beeld.");
  } else {
    ok("Ingediend. Volgende scenario…");
  }

  fetch(FORM_ACTION, {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: data.toString()
  });

  const delayMs = needsTenSeconds ? 10000 : 600;

  setTimeout(() => {
    idx++;
    if(idx >= ORDER.length){
      el("scenarioTitle").textContent = "Klaar!";
      el("givenLocation").textContent = "Alle scenario’s zijn afgerond.";
      el("givenDateTime").textContent = "Je kunt dit tabblad sluiten.";
      show(el("errorBox"), false);
      ok("Dankjewel!");
      el("reportForm").style.display = "none";
      el("scenarioImg").style.display = "none";
      el("scenarioBadge").textContent = `Scenario ${ORDER.length} van ${ORDER.length}`;
      el("progressText").textContent = `${ORDER.length} / ${ORDER.length}`;
      el("progressBar").style.width = "100%";
      return;
    }

    el("submitBtn").disabled = false;
    renderScenario();
  }, delayMs);
});
</script>
</body>
</html>
