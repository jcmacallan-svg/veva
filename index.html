<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Short Report Trainer</title>
<style>
  body { font-family: Arial, sans-serif; background:#f6f7fb; margin:0; }
  main { max-width:980px; margin:auto; padding:20px; }
  .card { background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 14px rgba(0,0,0,.1); }
  .grid { display:grid; grid-template-columns:1.2fr 1fr; gap:20px; }
  @media (max-width: 900px){ .grid { grid-template-columns: 1fr; } }
  img { width:100%; border-radius:10px; border:1px solid #e5e7eb; }

  label { font-weight:bold; display:block; margin-top:10px; }
  input, textarea { width:100%; padding:10px; margin-top:6px; border-radius:10px; border:1px solid #d1d5db; }
  textarea { min-height:90px; resize:vertical; }

  button { margin-top:15px; padding:10px 14px; background:#2563eb; color:white; border:none; border-radius:10px; cursor:pointer; }
  button:disabled { opacity:.6; cursor:not-allowed; }

  .hint { font-size:13px; color:#555; margin-top:8px; line-height:1.35; }
  .ok { color:#065f46; font-weight:bold; }
  .warn { color:#92400e; font-weight:bold; }
  .small { font-size:12px; color:#6b7280; }

  /* progress */
  .progressWrap { margin-top:12px; }
  .progressTop { display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }
  .bar { height:12px; background:#e5e7eb; border-radius:999px; overflow:hidden; }
  .fill { height:100%; width:0%; background:#2563eb; transition: width .25s ease; }
</style>
</head>

<body>
<main>
  <div class="card">
    <h2>Short Report Exercise</h2>
    <div class="hint">
      Fill in the short report in English. Use short, factual phrases.<br>
      Order: <b>WHO → WHAT → WHERE → WHEN → HOW → NOTE</b><br>
      <b>WHEN must be a DTG:</b> <code>DDHHMMZMONYY</code> (e.g., <code>251430ZJAN26</code>)
    </div>

    <!-- Progress -->
    <div class="progressWrap">
      <div class="progressTop">
        <div class="small">
          Progress: <b><span id="progressText">0/0</span></b>
          &nbsp;|&nbsp; Current scenario: <b><span id="scenarioLabel">—</span></b>
        </div>
        <button id="restartBtn" type="button" style="background:#374151;">Restart (new random order)</button>
      </div>
      <div class="bar" aria-label="progress bar">
        <div class="fill" id="progressFill"></div>
      </div>
    </div>

    <div class="grid" style="margin-top:14px;">
      <div>
        <img id="scenarioImg" src="" alt="Scenario image">
        <p class="hint">
          <b>Given location:</b> <span id="givenLocation">—</span><br>
          <b>Given date/time:</b> <span id="givenDateTime">—</span>
        </p>
        <p class="hint">
          <b>Note:</b> WHERE and WHEN are not pre-filled. Students must type them in.
        </p>
      </div>

      <form id="reportForm" novalidate>
        <!-- hidden: scenario id stored in your Google Form -->
        <input type="hidden" id="scenarioId" value="">
        <!-- hidden: scenario date/time parts for validation -->
        <input type="hidden" id="scenarioDTG_DD" value="">
        <input type="hidden" id="scenarioDTG_MON" value="">
        <input type="hidden" id="scenarioDTG_YY" value="">

        <label>Student name</label>
        <input id="studentName" required>

        <label>WHO – Who is reporting?</label>
        <input id="who" required>

        <label>WHAT – Main group (and sub group if necessary), Color, Size, Text.</label>
        <input id="what" required>

        <label>WHERE – Coordinate / Location</label>
        <input id="where" required>

        <label>WHEN – Date time group (DTG)</label>
        <input id="when" placeholder="e.g., 251430ZJAN26" required>

        <label>HOW – Approach, markings, contactperson</label>
        <input id="how" required>

        <label>NOTE – Additional information</label>
        <textarea id="note" required></textarea>

        <button id="submitBtn" type="submit">Submit & Next</button>
        <div class="hint" id="msg"></div>
      </form>
    </div>
  </div>
</main>

<script>
/* =========================
   1) GOOGLE FORM SETTINGS
   ========================= */
const FORM_ID = "1FAIpQLSe3-GOHTC225b7tcRCHNH5xK9X0lNplRsGfmlQcL_1pMVhcqA";

const ENTRY = {
  studentName: "entry.697813513",
  who:         "entry.950739082",
  what:        "entry.724583571",
  where:       "entry.1339994849",
  when:        "entry.2133718989",
  how:         "entry.464832105",
  note:        "entry.2091019514",
  scenarioId:  "entry.1482083770"
};

/* =========================
   2) SCENARIOS (8+)
   - dateISO: YYYY-MM-DD
   - timeHM:  HH:MM (24h)
   ========================= */
const SCENARIOS = [
  { id:"S1", img:"images/img1.jpg", location:"Sporthal Van der Knaap – Main entrance", dateISO:"2026-01-25", timeHM:"14:35" },
  { id:"S2", img:"images/img2.jpg", location:"Bioscoop Pathé – Parking lot", dateISO:"2026-01-25", timeHM:"09:10" },
  { id:"S3", img:"images/img3.jpg", location:"AH Stadspoort Supermarket – Aisle 4", dateISO:"2026-01-26", timeHM:"18:22" },
  { id:"S4", img:"images/img4.jpg", location:"Kasteel Hoekelum – Near the lake", dateISO:"2026-01-26", timeHM:"12:05" },

  { id:"S5", img:"images/img5.jpg", location:"Station Ede-Wageningen – Platform 2", dateISO:"2026-01-27", timeHM:"16:48" },
  { id:"S6", img:"images/img6.jpg", location:"Ziekenhuis Gelderse Vallei – Emergency entrance", dateISO:"2026-01-27", timeHM:"11:20" },
  { id:"S7", img:"images/img7.jpg", location:"Museum Kröller-Müller – Sculpture garden", dateISO:"2026-01-28", timeHM:"08:55" },
  { id:"S8", img:"images/img8.jpg", location:"Zwembad De Peppel – Rear exit", dateISO:"2026-01-28", timeHM:"19:03" },
];

/* =========================
   3) RANDOM ORDER PER USER
   ========================= */
const ORDER_KEY = "sr_random_order_v3";
const INDEX_KEY = "sr_random_index_v3";
const DONE_KEY  = "sr_done_count_v3";

function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1; i>0; i--){
    const j = Math.floor(Math.random() * (i+1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function freshStart(){
  const newOrder = shuffle(SCENARIOS.map(s => s.id));
  sessionStorage.setItem(ORDER_KEY, JSON.stringify(newOrder));
  sessionStorage.setItem(INDEX_KEY, "0");
  sessionStorage.setItem(DONE_KEY, "0");
  return newOrder;
}

function getOrder(){
  const saved = sessionStorage.getItem(ORDER_KEY);
  if(saved){
    try { return JSON.parse(saved); } catch(e){}
  }
  return freshStart();
}

function getIndex(){ return parseInt(sessionStorage.getItem(INDEX_KEY) || "0", 10); }
function setIndex(i){ sessionStorage.setItem(INDEX_KEY, String(i)); }
function getDone(){ return parseInt(sessionStorage.getItem(DONE_KEY) || "0", 10); }
function setDone(n){ sessionStorage.setItem(DONE_KEY, String(n)); }

function scenarioById(id){ return SCENARIOS.find(s => s.id === id); }

/* =========================
   4) DTG PARSE + VALIDATION
   - Must be DDHHMMZMONYY
   - Must match scenario DD/MON/YY
   ========================= */
const MONTHS = ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];

function monthIndexToMon(idx0){
  return MONTHS[idx0] || null;
}

// scenario: YYYY-MM-DD -> {DD, MON, YY}
function dtgPartsFromISO(dateISO){
  const m = dateISO.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(!m) return null;
  const yyyy = parseInt(m[1], 10);
  const mm = parseInt(m[2], 10);
  const dd = parseInt(m[3], 10);

  const MON = monthIndexToMon(mm - 1);
  const YY = String(yyyy % 100).padStart(2, "0");
  const DD = String(dd).padStart(2, "0");
  return { DD, MON, YY };
}

// returns {ok, dd, hh, mm, mon, yy, normalized, reason}
function parseDTG(inputRaw){
  const input = (inputRaw || "").trim().toUpperCase();

  // strict: DDHHMMZMONYY
  const m = input.match(/^(\d{2})(\d{2})(\d{2})Z([A-Z]{3})(\d{2})$/);
  if(!m) return { ok:false, reason:"Use DTG format DDHHMMZMONYY (e.g., 251430ZJAN26)." };

  const dd = parseInt(m[1], 10);
  const hh = parseInt(m[2], 10);
  const mi = parseInt(m[3], 10);
  const mon = m[4];
  const yy = m[5];

  if(dd < 1 || dd > 31) return { ok:false, reason:"DTG day (DD) must be 01–31." };
  if(hh < 0 || hh > 23) return { ok:false, reason:"DTG hour (HH) must be 00–23." };
  if(mi < 0 || mi > 59) return { ok:false, reason:"DTG minutes (MM) must be 00–59." };
  if(!MONTHS.includes(mon)) return { ok:false, reason:"DTG month must be JAN, FEB, MAR, APR, MAY, JUN, JUL, AUG, SEP, OCT, NOV, or DEC." };

  return { ok:true, dd: String(dd).padStart(2,"0"), hh: String(hh).padStart(2,"0"), mm: String(mi).padStart(2,"0"), mon, yy, normalized: input };
}

/* =========================
   5) RENDER + PROGRESS
   ========================= */
let order = getOrder();
let idx = getIndex();
let done = getDone();
let current = scenarioById(order[idx]);

const el = (id) => document.getElementById(id);

function updateProgress(){
  const total = order.length;
  const completed = done;
  el("progressText").textContent = `${Math.min(completed, total)}/${total}`;
  const pct = total ? (Math.min(completed, total) / total) * 100 : 0;
  el("progressFill").style.width = pct + "%";
}

function showScenario(s){
  current = s;
  el("scenarioImg").src = s.img;
  el("scenarioLabel").textContent = s.id;
  el("givenLocation").textContent = s.location;

  const parts = dtgPartsFromISO(s.dateISO);
  const pretty = `${parts.DD} ${parts.MON} 20${parts.YY} ${s.timeHM}`;
  el("givenDateTime").textContent = pretty;

  el("scenarioId").value = s.id;

  // store expected date parts for DTG match
  el("scenarioDTG_DD").value = parts.DD;
  el("scenarioDTG_MON").value = parts.MON;
  el("scenarioDTG_YY").value = parts.YY;

  // NOT pre-filled:
  el("where").value = "";
  el("when").value = "";
  el("msg").textContent = "";

  updateProgress();
}

showScenario(current);

/* Restart random order button */
el("restartBtn").addEventListener("click", () => {
  order = freshStart();
  idx = 0; setIndex(0);
  done = 0; setDone(0);
  showScenario(scenarioById(order[idx]));
});

/* =========================
   6) SUBMIT + NEXT
   ========================= */
el("reportForm").addEventListener("submit", (e) => {
  e.preventDefault();

  const msg = el("msg");
  msg.textContent = "";

  // required fields
  const requiredIds = ["studentName","who","what","where","when","how","note"];
  for(const rid of requiredIds){
    if(!el(rid).value.trim()){
      msg.innerHTML = `<span class="warn">Please complete all fields.</span>`;
      return;
    }
  }

  // DTG parse
  const dtgRes = parseDTG(el("when").value);
  if(!dtgRes.ok){
    msg.innerHTML = `<span class="warn">WHEN invalid.</span> ${dtgRes.reason}`;
    el("when").focus();
    return;
  }

  // enforce date match with scenario
  const expDD = el("scenarioDTG_DD").value;
  const expMON = el("scenarioDTG_MON").value;
  const expYY = el("scenarioDTG_YY").value;

  if(dtgRes.dd !== expDD || dtgRes.mon !== expMON || dtgRes.yy !== expYY){
    msg.innerHTML = `<span class="warn">WHEN invalid.</span> DTG date must match the given scenario date.`;
    el("when").focus();
    return;
  }

  const btn = el("submitBtn");
  btn.disabled = true;

  const data = new FormData();
  data.append(ENTRY.studentName, el("studentName").value.trim());
  data.append(ENTRY.who,         el("who").value.trim());
  data.append(ENTRY.what,        el("what").value.trim());
  data.append(ENTRY.where,       el("where").value.trim());
  data.append(ENTRY.when,        dtgRes.normalized); // normalized uppercase
  data.append(ENTRY.how,         el("how").value.trim());
  data.append(ENTRY.note,        el("note").value.trim());
  data.append(ENTRY.scenarioId,  el("scenarioId").value);

  fetch(`https://docs.google.com/forms/d/e/${FORM_ID}/formResponse`, {
    method: "POST",
    mode: "no-cors",
    body: data
  });

  msg.innerHTML = `<span class="ok">✔ Submitted. Loading next scenario…</span>`;

  // keep student name
  const studentName = el("studentName").value;

  // reset
  e.target.reset();
  el("studentName").value = studentName;

  // progress
  done = getDone() + 1;
  setDone(done);

  // next scenario
  idx = (idx + 1) % order.length;
  setIndex(idx);
  showScenario(scenarioById(order[idx]));

  btn.disabled = false;
});
</script>
</body>
</html>
